<!--pages/student/task-detail/task-detail.wxml-->
<view class="detail-container">
  <!-- å¯¼èˆªæ  -->
  <view class="nav-bar">
    <view class="nav-left" bindtap="onBack">
      <text class="nav-icon">â†</text>
      <text>è¿”å›</text>
    </view>
    <view class="nav-title">ä»»åŠ¡è¯¦æƒ…</view>
    <view class="nav-right">
      <text class="more-icon">â‹¯</text>
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <scroll-view class="content" scroll-y wx:if="{{!loading}}">
    <!-- ä»»åŠ¡ä¿¡æ¯åŒº -->
    <view class="task-info-section">
      <view class="task-header">
        <text class="task-icon">ğŸ“„</text>
        <text class="task-title">{{task.title}}</text>
      </view>
      
      <view class="task-description" wx:if="{{task.description}}">
        <text class="desc-icon">ğŸ“</text>
        <text class="desc-text">{{task.description}}</text>
      </view>

      <view class="time-info">
        <view class="time-item">
          <text class="time-icon">â°</text>
          <text class="time-label">å¼€å§‹:</text>
          <text class="time-value">{{formatTime(task.start_time)}}</text>
        </view>
        <view class="time-item">
          <text class="time-icon">â°</text>
          <text class="time-label">æˆªæ­¢:</text>
          <text class="time-value">{{formatTime(task.end_time)}}</text>
        </view>
      </view>

      <view class="file-requirements" wx:if="{{task.allowed_formats}}">
        <view class="req-item">
          <text class="req-icon">ğŸ“</text>
          <text class="req-label">æ ¼å¼:</text>
          <text class="req-value">{{allowedFormatsText}}</text>
        </view>
        <view class="req-item" wx:if="{{task.filename_template}}">
          <text class="req-icon">ğŸ“‹</text>
          <text class="req-label">å‘½å:</text>
          <text class="req-value">{{task.filename_template}}</text>
        </view>
      </view>
    </view>

    <!-- æäº¤ç»Ÿè®¡ -->
    <view class="submit-stats-section">
      <view class="stats-header">
        <text class="stats-icon">ğŸ“Š</text>
        <text class="stats-title">å…¨ç­æäº¤æƒ…å†µ ({{task.submitted_count}}/{{task.total_students}})</text>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progressWidth}}%"></view>
      </view>
      <view class="stats-details">
        <view class="stat-item">
          <text class="stat-label">æ€»äººæ•°:</text>
          <text class="stat-value">{{task.total_students}}äºº</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">å·²æäº¤:</text>
          <text class="stat-value success">{{task.submitted_count}}äºº</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">æœªæäº¤:</text>
          <text class="stat-value warning">{{unsubmittedCount}}äºº</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">æäº¤ç‡:</text>
          <text class="stat-value">{{submitRate}}%</text>
        </view>
      </view>
    </view>

    <!-- æˆ‘çš„æäº¤çŠ¶æ€ -->
    <view class="my-submission-section">
      <view class="section-header">
        <text class="section-icon">ğŸ“¤</text>
        <text class="section-title">æˆ‘çš„æäº¤çŠ¶æ€</text>
      </view>
      
      <view class="submission-card" wx:if="{{mySubmission}}">
        <view class="submission-status">
          <text class="status-label">çŠ¶æ€:</text>
          <view class="status-tag {{getSubmissionStatusClass(mySubmission)}}">
            {{getSubmissionStatusText(mySubmission)}}
          </view>
        </view>
        
        <view class="submission-time" wx:if="{{mySubmission.submitted_at}}">
          <text class="time-icon">â°</text>
          <text>æäº¤æ—¶é—´: {{formatTime(mySubmission.submitted_at)}}</text>
        </view>

        <!-- å·²æäº¤æ–‡ä»¶åˆ—è¡¨ -->
        <view class="submitted-files" wx:if="{{mySubmission.files && mySubmission.files.length > 0}}">
          <view class="files-header">
            <text class="files-icon">ğŸ“</text>
            <text>å·²æäº¤æ–‡ä»¶</text>
          </view>
          <view class="file-item" wx:for="{{mySubmission.files}}" wx:key="id">
            <view class="file-info">
              <text class="file-icon">ğŸ“„</text>
              <view class="file-details">
                <text class="file-name">{{item.original_name}}</text>
                <text class="file-size">{{formatFileSize(item.file_size)}}</text>
              </view>
            </view>
            <view class="file-actions">
              <text class="action-btn" bindtap="onPreviewFile" data-url="{{item.file_path}}" data-name="{{item.original_name}}">ğŸ‘ï¸ é¢„è§ˆ</text>
              <text class="action-btn" bindtap="onDownloadFile" data-url="{{item.file_path}}" data-name="{{item.original_name}}">ğŸ“¥ ä¸‹è½½</text>
            </view>
          </view>
        </view>

        <!-- æ‰¹é˜…ä¿¡æ¯ -->
        <view class="review-info" wx:if="{{mySubmission.status === 'reviewed'}}">
          <view class="review-score" wx:if="{{mySubmission.score !== null}}">
            <text class="score-icon">â­</text>
            <text>å¾—åˆ†: {{mySubmission.score}}</text>
          </view>
          <view class="review-comment" wx:if="{{mySubmission.comment}}">
            <text class="comment-icon">ğŸ’¬</text>
            <text class="comment-text">{{mySubmission.comment}}</text>
          </view>
        </view>

        <!-- ä¿®æ”¹æäº¤æŒ‰é’® -->
        <view class="resubmit-section" wx:if="{{mySubmission && mySubmission.status !== 'reviewed'}}">
          <button class="resubmit-button" bindtap="onResubmit">
            ğŸ”„ ä¿®æ”¹æäº¤
          </button>
        </view>
      </view>

      <!-- æœªæäº¤çŠ¶æ€ -->
      <view class="no-submission" wx:if="{{!mySubmission}}">
        <text class="no-submission-icon">ğŸ“­</text>
        <text class="no-submission-text">å°šæœªæäº¤</text>
      </view>
    </view>

    <!-- æäº¤äººå‘˜åˆ—è¡¨ -->
    <view class="students-list-section">
      <view class="section-header">
        <text class="section-icon">ğŸ“‹</text>
        <text class="section-title">å…¨ç­å­¦ç”Ÿæäº¤æƒ…å†µ (æŒ‰å­¦å·æ’åº)</text>
      </view>
      
      <!-- å·²æäº¤å­¦ç”Ÿ -->
      <view class="students-group" wx:if="{{submittedStudents.length > 0}}">
        <view class="group-header">
          <text class="group-title">âœ… å·²æäº¤ ({{submittedStudents.length}}äºº)</text>
        </view>
        <view class="student-item" wx:for="{{submittedStudents}}" wx:key="id">
          <view class="student-info">
            <text class="student-icon">âœ…</text>
            <text class="student-id">{{item.student.student_id || item.student.username}}</text>
            <text class="student-name">{{item.student.name}}</text>
          </view>
          <view class="submit-details">
            <view class="submit-time">
              <text class="time-icon">â°</text>
              <text>{{formatTime(item.submitted_at)}}</text>
            </view>
            <view class="submit-status" wx:if="{{item.is_on_time !== undefined}}">
              <text class="status-icon" wx:if="{{item.is_on_time}}">ğŸŸ¢</text>
              <text class="status-icon" wx:if="{{!item.is_on_time}}">ğŸŸ¡</text>
              <text class="status-text" wx:if="{{item.is_on_time}}">æŒ‰æ—¶</text>
              <text class="status-text" wx:if="{{!item.is_on_time}}">è¿Ÿäº¤</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æœªæäº¤å­¦ç”Ÿ -->
      <view class="students-group" wx:if="{{unsubmittedStudents.length > 0}}">
        <view class="group-header">
          <text class="group-title">ğŸ”´ æœªæäº¤ ({{unsubmittedStudents.length}}äºº)</text>
        </view>
        <view class="student-item" wx:for="{{unsubmittedStudents}}" wx:key="id">
          <view class="student-info">
            <text class="student-icon">ğŸ”´</text>
            <text class="student-id">{{item.student.student_id || item.student.username}}</text>
            <text class="student-name">{{item.student.name}}</text>
          </view>
          <text class="no-submit-text">æœªæäº¤</text>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{submittedStudents.length === 0 && unsubmittedStudents.length === 0}}">
        <view class="empty-icon">ğŸ“</view>
        <view class="empty-text">æš‚æ— å­¦ç”Ÿæ•°æ®</view>
      </view>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <view class="bottom-actions" wx:if="{{!loading}}">
    <button class="submit-button" bindtap="onSubmit" wx:if="{{!mySubmission}}">
      ğŸ“¤ ç«‹å³æäº¤
    </button>
    <view class="deadline-warning" wx:if="{{mySubmission && mySubmission.status === 'reviewed'}}">
      <text>âš ï¸ å·²æ‰¹é˜…ï¼Œä¸å¯ä¿®æ”¹</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>
